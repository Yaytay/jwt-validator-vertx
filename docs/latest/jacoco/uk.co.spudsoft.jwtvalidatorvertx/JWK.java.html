<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JWK.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JWT Validator - Vertx</a> &gt; <a href="index.source.html" class="el_package">uk.co.spudsoft.jwtvalidatorvertx</a> &gt; <span class="el_source">JWK.java</span></div><h1>JWK.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2022 jtalbut
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package uk.co.spudsoft.jwtvalidatorvertx;

import com.google.common.base.Strings;
import io.vertx.core.json.JsonObject;
import java.security.InvalidKeyException;
import java.security.NoSuchAlgorithmException;
import java.security.PublicKey;
import java.security.Signature;
import java.security.SignatureException;
import java.security.spec.InvalidKeySpecException;
import java.security.spec.InvalidParameterSpecException;

import java.security.InvalidAlgorithmParameterException;
import java.security.spec.AlgorithmParameterSpec;
import java.util.Arrays;
import java.util.List;
import javax.annotation.Nullable;
import uk.co.spudsoft.jwtvalidatorvertx.impl.ECJwkBuilder;
import uk.co.spudsoft.jwtvalidatorvertx.impl.EdECJwkBuilder;
import uk.co.spudsoft.jwtvalidatorvertx.impl.RSAJwkBuilder;

/**
 * Represent a single Json Web Key as defined in RFC 7517.https://datatracker.ietf.org/doc/html/rfc7517.
 * 
 * This class (more specifically the implementations of JwkBuilder that this class uses) is the bridge between JDK {@link java.security.PublicKey}s and the JSON of a JWK.
 * 
 * @author jtalbut
 * @param &lt;T&gt; The specific class of PublicKey represented by this JWK.
 * A typical usage of the JWK should not care about the type of key and should be able to use JWK&amp;lt;?&gt;.
 */
public abstract class JWK&lt;T extends PublicKey&gt; {
  
<span class="fc" id="L49">  private static final List&lt;JwkBuilder&lt;?&gt;&gt; BUILDERS = Arrays.asList(</span>
    new RSAJwkBuilder()
    , new ECJwkBuilder()
    , new EdECJwkBuilder()
  );
  
  private final long expiryMs;
  
  private final JsonObject json;
  private final String kid;
  private final String use;
  private final String kty;
  private final T key;

  /**
   * Constructor, for use by (probably private) sub classes.
   * 
   * @param expiryMs The expiry time for the JWK.
   * This value is only relevant if the JWK is cached, it is not part of the JWK itself.
   * @param json The JSON for the JWK.
   * @param key The key in the JWK.
   */
<span class="fc" id="L71">  protected JWK(long expiryMs, JsonObject json, T key) {</span>
<span class="fc" id="L72">    this.expiryMs = expiryMs;</span>
<span class="fc" id="L73">    this.json = json;</span>

<span class="fc" id="L75">    this.kid = json.getString(&quot;kid&quot;);</span>
<span class="fc" id="L76">    this.use = json.getString(&quot;use&quot;);</span>
<span class="fc" id="L77">    this.kty = json.getString(&quot;kty&quot;);</span>
    
<span class="fc" id="L79">    this.key = key;</span>
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">    assert(key != null);</span>

<span class="fc bfc" id="L82" title="All 2 branches covered.">    if (Strings.isNullOrEmpty(kid)) {</span>
<span class="fc" id="L83">      throw new IllegalArgumentException(&quot;Key ID (kid) not specified in JWK&quot;);</span>
    }    
<span class="fc" id="L85">  }  </span>
  
  /**
   * Factory method to create a JWK from its JSON representation.
   * 
   * This is expected to result in a call to the JWK constructor that takes in both the JSON and the PublicKey.
   * 
   * @param expiryMs The time in ms from the epoch (i.e. to be compared with System.currentTimeMillis) at which this data should be discarded.
   *    Should be found by parsing cache-control headers.
   * @param jo The JsonObject that contains the JWK as defined in RFC7517.
   * @return a newly created JWK of an appropriate type.
   * @throws java.security.NoSuchAlgorithmException if the algorithm in the JWK is not known.
   * @throws java.security.spec.InvalidKeySpecException if the key specification in the JWK is inappropriate for the key factory to produce a key.
   * @throws java.security.spec.InvalidParameterSpecException  if there is a bug in the JWK code.
   */
  public static JWK&lt;?&gt; create(long expiryMs, JsonObject jo) throws NoSuchAlgorithmException, InvalidKeySpecException, InvalidParameterSpecException {

<span class="fc" id="L102">    String kty = jo.getString(&quot;kty&quot;);</span>
    
<span class="fc bfc" id="L104" title="All 2 branches covered.">    if (Strings.isNullOrEmpty(kty)) {</span>
<span class="fc" id="L105">      throw new IllegalArgumentException(&quot;Key type (kty) not specified in JWK&quot;);</span>
    } else {
<span class="fc bfc" id="L107" title="All 2 branches covered.">      for (JwkBuilder&lt;?&gt; builder : BUILDERS) {</span>
<span class="fc bfc" id="L108" title="All 2 branches covered.">        if (builder.canCreateFromKty(kty)) {</span>
<span class="fc" id="L109">          return builder.create(expiryMs, jo);</span>
        }
<span class="fc" id="L111">      }</span>
<span class="fc" id="L112">      throw new IllegalArgumentException(&quot;Unsupported key type: &quot; + kty);</span>
    }
  }
  
  /**
   * Factory method to create a JWK from a PublicKey.
   * 
   * This is expected to result in a call to the JWK constructor that takes in both the JSON and the PublicKey.
   * 
   * @param expiryMs The expiry time for the JWK.
   * This value is only relevant if the JWK is cached, it is not part of the JWK itself.
   * @param kid The ID to use in the JWK.
   * @param key The key to convert to JSON.
   * @return a newly created JWK object containing both JSON and JDK PublicKey.
   * @throws InvalidParameterSpecException if the data in the key does not represent a valid key (this should indicate a bug in this library).
   * @throws NoSuchAlgorithmException if the underlying JDK crypto subsystem cannot process this algorithm family.
   */
  public static JWK&lt;?&gt; create(long expiryMs, String kid, PublicKey key) throws InvalidParameterSpecException, NoSuchAlgorithmException {
<span class="pc bpc" id="L130" title="1 of 2 branches missed.">    for (JwkBuilder&lt;?&gt; builder : BUILDERS) {</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">      if (builder.canCreateFromKey(key)) {</span>
<span class="fc" id="L132">        return builder.create(expiryMs, kid, key);</span>
      }
<span class="fc" id="L134">    }</span>
<span class="nc" id="L135">    throw new IllegalArgumentException(&quot;Cannot process key of type &quot; + key.getClass().getSimpleName());</span>
  }
    
  
  /**
   * Get the expiry time in ms from the epoch.
   * @return the expiry time in ms from the epoch.
   */
  public long getExpiryMs() {
<span class="fc" id="L144">    return expiryMs;</span>
  }

  /**
   * Get the key identifier.
   * &lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc7517#section-4.5&quot;&gt;https://datatracker.ietf.org/doc/html/rfc7517#section-4.5&lt;/a&gt;
   * @return the key identifier.
   */
  public String getKid() {
<span class="fc" id="L153">    return kid;</span>
  }

  /**
   * Get the type of key represented by the JWK.
   * @return the type of key represented by the JWK.
   */
  public String getKty() {
<span class="nc" id="L161">    return kty;</span>
  }
  
  /**
   * Get the key use string.
   * &lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc7517#section-4.2&quot;&gt;https://datatracker.ietf.org/doc/html/rfc7517#section-4.2&lt;/a&gt;
   * This should be &quot;sig&quot; for all known uses, but its presence is optional, so it's ignored.
   *
   * @return the key use string.
   */
  public String getUse() {
<span class="fc" id="L172">    return use;</span>
  }

  /**
   * Get the key represented by this JWK.
   *
   * @return the key represented by this JWK.
   */
  public T getKey() {
<span class="fc" id="L181">    return key;</span>
  }

  /**
   * Get the key in its original, JWK compatible, JSON format.
   *
   * @return the key in its original, JWK compatible, JSON format.
   */
  public JsonObject getJson() {
<span class="fc" id="L190">    return json;</span>
  }

  /**
   * Verify a signature using the key in this JWK.
   *
   * @param algorithm The algorithm specified in the token, which may not be the same as the JWK algorithm (RSA-PSS).
   * @param signature The signature that has been provided for the JWT.
   * @param data The data to be verified.
   * @return True if the signature can only have been created using this key and the data provided.
   *
   * @throws InvalidKeyException if the key is not appropriate for the signer.
   * @throws NoSuchAlgorithmException if the algorithm is not known to the JDK security subsystem,.
   * @throws SignatureException if the signature is invalid
   * @throws InvalidAlgorithmParameterException if the algorithm is configured with incorrect parameters.
   */
  public boolean verify(JsonWebAlgorithm algorithm, byte[] signature, byte[] data) throws InvalidKeyException, NoSuchAlgorithmException, SignatureException, InvalidAlgorithmParameterException {
<span class="fc" id="L207">    return verify(algorithm.getJdkAlgName(), algorithm.getParameter(), (PublicKey) key, signature, data);</span>
  }

  /**
   * Verify a signature using JDK terminology.
   *
   * @param jdkAlgName The name of the algorithm as used by the JDK.
   * @param parameter Any parameter required by the algorithm.
   * @param key The public key to verify the signature.
   * @param signature The signature that has been provided for the JWT.
   * @param data The data to be verified.
   * @return True if the signature can only have been created using this key and the data provided.
   *
   * @throws InvalidKeyException if the key is not appropriate for the signer.
   * @throws NoSuchAlgorithmException if the algorithm is not known to the JDK security subsystem,.
   * @throws SignatureException if the signature is invalid
   * @throws InvalidAlgorithmParameterException if the algorithm is configured with incorrect parameters.
   */
  public static boolean verify(String jdkAlgName, @Nullable AlgorithmParameterSpec parameter, PublicKey key, byte[] signature, byte[] data) throws InvalidKeyException, NoSuchAlgorithmException, SignatureException, InvalidAlgorithmParameterException {
<span class="fc" id="L226">    Signature signer = Signature.getInstance(jdkAlgName);</span>
<span class="fc bfc" id="L227" title="All 2 branches covered.">    if (parameter != null) {</span>
<span class="fc" id="L228">      signer.setParameter(parameter);</span>
    }
<span class="fc" id="L230">    signer.initVerify(key);</span>
<span class="fc" id="L231">    signer.update(data);</span>
<span class="fc" id="L232">    return signer.verify(signature);</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>